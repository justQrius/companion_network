<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>epic-1</epicId>
    <storyId>1-4</storyId>
    <title>Configure Environment Variables and Secrets</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-4-configure-environment-variables-and-secrets.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>secure API key management</iWant>
    <soThat>I can authenticate with Gemini 2.5 Pro without exposing secrets in version control</soThat>
    <tasks>
- [ ] Task 1: Configure Git Exclusion (AC: 3)
  - [ ] Subtask 1.1: Append `.env` to `.gitignore` file
  - [ ] Subtask 1.2: Verify `.env` is ignored using `git check-ignore .env` (or manual check)

- [ ] Task 2: Create Environment Files (AC: 1, 2)
  - [ ] Subtask 2.1: Create `.env.example` with template variables
  - [ ] Subtask 2.2: Create `.env` file (if not exists) and populate with `GOOGLE_API_KEY` (ask user or use placeholder)
  - [ ] Subtask 2.3: Ensure `.env` contains the actual key format (e.g., `GOOGLE_API_KEY=AIza...`)

- [ ] Task 3: Verify Secrets Management (AC: 4, 5)
  - [ ] Subtask 3.1: Create `tests/verify_secrets.py`
  - [ ] Subtask 3.2: Script should load dotenv and check for `GOOGLE_API_KEY` presence
  - [ ] Subtask 3.3: Run script to confirm success
  - [ ] Subtask 3.4: Verify `.env` is NOT in `git status` but `.env.example` IS
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Secrets Configured**: `.env` file exists in project root containing `GOOGLE_API_KEY`.
2. **Template Created**: `.env.example` exists in project root with `GOOGLE_API_KEY=your_api_key_here` (no real secrets).
3. **Git Exclusion**: `.env` is explicitly ignored in `.gitignore` and NOT tracked by Git.
4. **Git Tracking**: `.env.example` IS tracked by Git.
5. **Verification**: Script `tests/verify_secrets.py` confirms `GOOGLE_API_KEY` is loaded correctly from environment.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/architecture.md" title="Companion Network Architecture" section="Version Control Strategy">
        Secrets configuration best practices: API keys MUST NEVER be committed to version control. Use python-dotenv to load from .env file. .env must be explicitly in .gitignore. .env.example should be tracked with template values.
      </doc>
      <doc path="docs/architecture.md" title="Companion Network Architecture" section="Technology Stack Details">
        Dependencies listed in pyproject.toml: python-dotenv for environment variable management. Required for loading GOOGLE_API_KEY for Gemini 2.5 Pro authentication.
      </doc>
      <doc path="docs/prd.md" title="Product Requirements Document" section="Technical Stack">
        SQLite for session persistence, python-dotenv for environment variable management. Gemini 2.5 Pro as the LLM requires GOOGLE_API_KEY authentication.
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Epic 1: Story 1.4">
        Configure environment variables. .env file created in project root (gitignored). .env contains GOOGLE_API_KEY. .env.example contains template. .gitignore must include .env.
      </doc>
    </docs>
    <code>
      <artifact path=".gitignore" kind="config" symbol="N/A" lines="1-61" reason="Must be updated to include .env exclusion for Story 1.4 AC3">
        Currently missing .env entry. Need to append .env to ensure secrets are not tracked.
      </artifact>
      <artifact path="pyproject.toml" kind="config" symbol="dependencies" lines="6-11" reason="Shows python-dotenv is a declared dependency">
        python-dotenv already in dependencies list from Story 1.3. Can use for loading environment variables.
      </artifact>
      <artifact path="tests/verify_dependencies.py" kind="test" symbol="N/A" lines="1-1447" reason="Example of verification script pattern">
        Existing verification script demonstrates the pattern to follow for verify_secrets.py in this story.
      </artifact>
      <artifact path="tests/verify_structure.py" kind="test" symbol="N/A" lines="1-1226" reason="Another verification script showing standard testing approach">
        Pattern for tests that validate project configuration and setup.
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="python-dotenv" version="latest" usage="Load environment variables from .env file">
          Already installed in Story 1.3. Use load_dotenv() to load .env file.
        </package>
        <package name="google-adk" version=">=1.19.0" usage="Requires GOOGLE_API_KEY for Gemini authentication">
          Main consumer of GOOGLE_API_KEY environment variable.
        </package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint category="security" priority="critical">
      API keys must NEVER be committed to version control. .env file must be explicitly in .gitignore BEFORE creating .env file. (Architecture: lines 151-152)
    </constraint>
    <constraint category="security" priority="critical">
      Environment variable format: GOOGLE_API_KEY value from Google AI Studio. No fake/placeholder values in production .env.
    </constraint>
    <constraint category="development" priority="high">
      .env.example must be tracked by Git to provide template for other developers. Should contain placeholder value 'your_api_key_here'.
    </constraint>
    <constraint category="testing" priority="high">
      Verification script must NOT print actual API key value in logs. Only print OK/MISSING status for security.
    </constraint>
    <constraint category="development" priority="medium">
      Follow established verification pattern from tests/verify_dependencies.py. Use .venv\Scripts\python.exe for running tests.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="python-dotenv API" kind="library">
      <signature>load_dotenv(dotenv_path=None, stream=None, verbose=False, override=False, interpolate=True, encoding="utf-8")</signature>
      <description>Loads environment variables from .env file into os.environ</description>
      <path>External library (python-dotenv)</path>
    </interface>
    <interface name="os.getenv" kind="function">
      <signature>os.getenv(key, default=None)</signature>
      <description>Retrieves environment variable value. Returns None if not set.</description>
      <path>Python stdlib</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Verification scripts follow a standard pattern: 
      1. Import required modules (dotenv, os, sys)
      2. Attempt operation (load_dotenv, check environment variable)
      3. Assert expected state (key exists, not None)
      4. Print clear status message (OK or MISSING)
      5. Security: Never print actual secret values in output
      6. Run using virtual environment Python: .venv\Scripts\python.exe
    </standards>
    <locations>
      tests/verify_secrets.py (to be created)
    </locations>
    <ideas>
      <test id="AC5" criteria="Verification script confirms GOOGLE_API_KEY is loaded">
        Create tests/verify_secrets.py that: loads dotenv, checks os.getenv('GOOGLE_API_KEY'), prints OK if present, MISSING if not. Assert not None.
      </test>
      <test id="AC3" criteria=".env is explicitly ignored in .gitignore">
        Verify .env appears in .gitignore file. Can use git check-ignore .env command or grep '.env' .gitignore.
      </test>
      <test id="AC4" criteria=".env.example IS tracked by Git">
        Verify .env.example is NOT in .gitignore and IS in git status as tracked file.
      </test>
      <test id="manual-verification" criteria="Secrets not exposed">
        Manual check: git log --all --decorate -- .env should return empty. Ensures .env was never committed.
      </test>
    </ideas>
  </tests>
</story-context>
