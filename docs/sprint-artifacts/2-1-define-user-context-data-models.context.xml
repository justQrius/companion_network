<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Define User Context Data Models</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-define-user-context-data-models.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>structured data models for user context information</iWant>
    <soThat>each Companion can store and retrieve user preferences, schedules, and sharing rules in a type-safe manner</soThat>
    <tasks>
      <task id="1" ac="1,4,5,6">Create UserContext Dataclass
        <subtasks>
          <subtask>Import dataclass and field from dataclasses module</subtask>
          <subtask>Define UserContext class with user_id: str, name: str</subtask>
          <subtask>Add preferences: dict with default_factory=dict</subtask>
          <subtask>Add schedule: dict with default_factory=dict</subtask>
          <subtask>Add trusted_contacts: list with default_factory=list</subtask>
          <subtask>Add sharing_rules: dict with default_factory=dict</subtask>
          <subtask>Add type hints for all fields</subtask>
          <subtask>Verify alignment with Architecture doc schema</subtask>
        </subtasks>
      </task>
      <task id="2" ac="2,4,5,6">Create EventProposal Dataclass
        <subtasks>
          <subtask>Define EventProposal class with event_id: str, proposer: str, recipient: str</subtask>
          <subtask>Add status: str (enum values: "pending", "accepted", "declined", "counter")</subtask>
          <subtask>Add details: dict with default_factory=dict</subtask>
          <subtask>Add timestamp: str (ISO 8601 format)</subtask>
          <subtask>Add type hints for all fields</subtask>
          <subtask>Verify alignment with Architecture doc schema</subtask>
        </subtasks>
      </task>
      <task id="3" ac="3,4,5,6">Create SharingRule Dataclass
        <subtasks>
          <subtask>Define SharingRule class with contact_id: str</subtask>
          <subtask>Add allowed_categories: list with default_factory=list</subtask>
          <subtask>Add type hints for all fields</subtask>
          <subtask>Verify alignment with Architecture doc schema</subtask>
        </subtasks>
      </task>
      <task id="4" ac="1,2,3">Create shared/models.py File
        <subtasks>
          <subtask>Create `shared/models.py` file if it doesn't exist</subtask>
          <subtask>Add module docstring describing purpose</subtask>
          <subtask>Import all required modules (dataclasses)</subtask>
          <subtask>Place all three dataclasses in the file</subtask>
          <subtask>Verify file structure matches project conventions</subtask>
        </subtasks>
      </task>
      <task id="5" ac="1,2,3,4,5,6">Testing and Verification
        <subtasks>
          <subtask>Create test file `tests/test_models.py` (if tests directory exists)</subtask>
          <subtask>Create verification script `tests/verify_models.py` following Epic 1 pattern</subtask>
          <subtask>Test UserContext instantiation with all fields</subtask>
          <subtask>Test EventProposal instantiation with all fields</subtask>
          <subtask>Test SharingRule instantiation with all fields</subtask>
          <subtask>Test default_factory prevents mutable default argument issues</subtask>
          <subtask>Verify type hints work with IDE (mypy or type checker)</subtask>
          <subtask>Run basic import test: `from shared.models import UserContext, EventProposal, SharingRule`</subtask>
          <subtask>Run verification script before marking tasks complete</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">UserContext Dataclass: Python dataclass `UserContext` is defined in `shared/models.py` with fields: user_id (str), name (str), preferences (dict), schedule (dict), trusted_contacts (list), sharing_rules (dict)</criterion>
    <criterion id="2">EventProposal Dataclass: Python dataclass `EventProposal` is defined in `shared/models.py` with fields: event_id (str), proposer (str), recipient (str), status (str), details (dict), timestamp (str)</criterion>
    <criterion id="3">SharingRule Dataclass: Python dataclass `SharingRule` is defined in `shared/models.py` with fields: contact_id (str), allowed_categories (list)</criterion>
    <criterion id="4">Type Hints: Each dataclass uses Python 3.10+ type hints for IDE support</criterion>
    <criterion id="5">Default Factories: Default factories are used to prevent mutable default argument issues (e.g., `field(default_factory=dict)`)</criterion>
    <criterion id="6">Architecture Alignment: Models match the schemas from Architecture doc (`docs/architecture.md` lines 498-531)</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd.md" title="Product Requirements Document" section="Data Models (lines 327-361)">
        Defines UserContext and EventProposal JSON schemas. UserContext includes user_id, name, preferences (cuisine, dining_times, weekend_availability), schedule (busy_slots), trusted_contacts, and sharing_rules. EventProposal includes event_id, proposer, recipient, status, details (title, time, location), and timestamp.
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Data Models (lines 497-531)">
        Authoritative Python dataclass definitions for UserContext, EventProposal, and SharingRule. Specifies field types, default factories, and structure. UserContext uses field(default_factory=dict/list) for mutable defaults. EventProposal.status enum: "pending", "accepted", "declined", "counter". SharingRule.allowed_categories: ["availability", "cuisine_preferences", "dietary", "schedule"].
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Project Structure (lines 243-268)">
        Defines `shared/models.py` location in project structure. Models are shared across both Alice and Bob's agents. File location: `shared/models.py` (shared utilities package).
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Implementation Patterns (lines 358-407)">
        Naming conventions: Classes use PascalCase (UserContext, EventProposal, SharingRule). Modules use snake_case. Type hints required for all fields. Default factories prevent mutable default argument issues.
      </doc>
      <doc path="docs/epics.md" title="Epic Breakdown" section="Epic 2: Companion Agent Core (lines 314-351)">
        Story 2.1 details: Use dataclasses module (Python stdlib). UserContext.preferences stores cuisine types, dining_times, weekend_availability. UserContext.schedule stores busy_slots as ISO 8601 time ranges. EventProposal.status enum values. Models shared across both agents.
      </doc>
      <doc path="docs/sprint-artifacts/epic-1-retro-2025-12-02.md" title="Epic 1 Retrospective" section="Action Items">
        Verification script pattern: Continue `tests/verify_*.py` pattern established in Epic 1. Always create and run verification scripts before marking tasks complete. Team agreement: Verification-first approach.
      </doc>
    </docs>
    <code>
      <artifact path="shared/__init__.py" kind="package" symbol="shared package" reason="Package marker exists. `shared/models.py` will be created in this package." />
      <artifact path="docs/architecture.md" kind="reference" symbol="Data Models Schema" lines="498-531" reason="Authoritative Python code examples for UserContext, EventProposal, and SharingRule dataclasses. Must match these exact structures." />
    </code>
    <dependencies>
      <ecosystem name="python">
        <package name="python" version=">=3.10" reason="Required for dataclasses module and type hints" />
        <package name="dataclasses" version="stdlib" reason="Python 3.10+ stdlib module for dataclass decorator and field() function" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Data Models: Use Python dataclasses module (Python 3.10+ stdlib) for type-safe data structures</constraint>
    <constraint>Type Safety: All fields must use Python 3.10+ type hints for IDE support and type checking</constraint>
    <constraint>Default Factories: Use `field(default_factory=dict)` and `field(default_factory=list)` to prevent mutable default argument issues. Never use mutable defaults directly (e.g., `preferences: dict = {}` is wrong)</constraint>
    <constraint>Model Location: Models defined in `shared/models.py` to be shared across both Alice and Bob's agents</constraint>
    <constraint>Schema Alignment: Models must match schemas from Architecture doc (`docs/architecture.md` lines 498-531) exactly</constraint>
    <constraint>UserContext Structure: preferences stores cuisine types, dining_times, weekend_availability. schedule stores busy_slots as ISO 8601 time ranges</constraint>
    <constraint>EventProposal Status: Enum values must be "pending", "accepted", "declined", "counter" (string literals, not Python Enum class for MVP simplicity)</constraint>
    <constraint>File Structure: Follow project conventions established in Epic 1. Module docstring required. Import statements at top.</constraint>
    <constraint>Naming: Classes use PascalCase (UserContext, EventProposal, SharingRule). Module uses snake_case (models.py)</constraint>
  </constraints>
  <interfaces>
    <interface name="UserContext" kind="dataclass" signature="@dataclass&#10;class UserContext:&#10;    user_id: str&#10;    name: str&#10;    preferences: dict = field(default_factory=dict)&#10;    schedule: dict = field(default_factory=dict)&#10;    trusted_contacts: list = field(default_factory=list)&#10;    sharing_rules: dict = field(default_factory=dict)" path="shared/models.py" />
    <interface name="EventProposal" kind="dataclass" signature="@dataclass&#10;class EventProposal:&#10;    event_id: str&#10;    proposer: str&#10;    recipient: str&#10;    status: str  # &quot;pending&quot;, &quot;accepted&quot;, &quot;declined&quot;, &quot;counter&quot;&#10;    details: dict = field(default_factory=dict)&#10;    timestamp: str" path="shared/models.py" />
    <interface name="SharingRule" kind="dataclass" signature="@dataclass&#10;class SharingRule:&#10;    contact_id: str&#10;    allowed_categories: list = field(default_factory=list)  # [&quot;availability&quot;, &quot;cuisine_preferences&quot;, &quot;dietary&quot;, &quot;schedule&quot;]" path="shared/models.py" />
  </interfaces>
  <tests>
    <standards>Testing follows Epic 1 verification-first pattern. Create `tests/verify_models.py` script that validates all acceptance criteria before marking tasks complete. Test file `tests/test_models.py` should test instantiation, default factories, type hints, and import functionality. Use Python's built-in unittest or pytest if available. Verification script should be executable and provide clear pass/fail output.</standards>
    <locations>tests/test_models.py (unit tests), tests/verify_models.py (verification script)</locations>
    <ideas>
      <test id="AC1">Test UserContext instantiation with all required fields. Verify default factories create new empty dicts/lists, not shared mutable defaults.</test>
      <test id="AC2">Test EventProposal instantiation with all fields. Verify status accepts enum values: "pending", "accepted", "declined", "counter".</test>
      <test id="AC3">Test SharingRule instantiation with contact_id and allowed_categories list.</test>
      <test id="AC4">Verify type hints work with IDE (mypy or type checker). Test that invalid types are caught.</test>
      <test id="AC5">Test default_factory prevents mutable default argument issues: Create two UserContext instances, modify one's preferences dict, verify the other's preferences dict is unchanged.</test>
      <test id="AC6">Run import test: `from shared.models import UserContext, EventProposal, SharingRule` succeeds without errors.</test>
      <test id="verification">Run verification script `tests/verify_models.py` before marking any task complete. Script should validate all 6 acceptance criteria programmatically.</test>
    </ideas>
  </tests>
</story-context>

