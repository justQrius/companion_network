<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Initialize Alice's Companion Agent with ADK</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-2-initialize-alices-companion-agent-with-adk.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>Alice's Companion agent initialized using Google ADK</iWant>
    <soThat>Alice has an intelligent agent with persistent identity and memory</soThat>
    <tasks>
      <task id="1" ac="1,2">Set Up ADK Agent Framework
        <subtasks>
          <subtask>Import required ADK modules (Agent, DatabaseSessionService, InMemoryMemoryService)</subtask>
          <subtask>Import model configuration (Gemini 2.5 Pro)</subtask>
          <subtask>Create SQLite database path configuration (`companion_sessions.db`)</subtask>
          <subtask>Initialize DatabaseSessionService with SQLite database path</subtask>
          <subtask>Initialize InMemoryMemoryService</subtask>
          <subtask>Configure agent name: "Alice's Companion"</subtask>
          <subtask>Configure model: `gemini-2.5-pro`</subtask>
          <subtask>Create system instruction emphasizing coordination, privacy, natural conversation</subtask>
          <subtask>Set session ID: "alice_session"</subtask>
          <subtask>Combine all components to create agent instance</subtask>
          <subtask>Test agent instantiation (no errors)</subtask>
        </subtasks>
      </task>
      <task id="2" ac="3,4">Verify Agent Functionality
        <subtasks>
          <subtask>Verify agent.run() method exists and is callable</subtask>
          <subtask>Test agent.run() with simple message ("Hello")</subtask>
          <subtask>Verify session state is created in SQLite database</subtask>
          <subtask>Restart agent and verify session state persists</subtask>
          <subtask>Verify session data is retrievable after restart</subtask>
        </subtasks>
      </task>
      <task id="3" ac="1,2,3,4">Create Verification Script
        <subtasks>
          <subtask>Create `tests/verify_alice_agent.py` following Epic 1 verification pattern</subtask>
          <subtask>Test agent instantiation without errors</subtask>
          <subtask>Test agent.run() method availability</subtask>
          <subtask>Test session persistence (create session, restart, verify data)</subtask>
          <subtask>Verify all configuration matches AC requirements</subtask>
          <subtask>Run verification script before marking tasks complete</subtask>
        </subtasks>
      </task>
      <task id="4" ac="1,2,3,4">Testing and Documentation
        <subtasks>
          <subtask>Create basic test file `tests/test_alice_agent.py` (if tests directory exists)</subtask>
          <subtask>Test agent initialization with all required components</subtask>
          <subtask>Test agent.run() with sample messages</subtask>
          <subtask>Test session persistence across restarts</subtask>
          <subtask>Add docstrings to agent.py explaining configuration</subtask>
          <subtask>Document system instruction rationale</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
1. **Agent Configuration**: Agent is configured with: Agent name: "Alice's Companion", Model: Gemini 2.5 Pro (`gemini-2.5-pro`), System instruction: "You are Alice's personal Companion agent. You coordinate plans on Alice's behalf...", SessionService: DatabaseSessionService with SQLite (`companion_sessions.db`), MemoryService: InMemoryMemoryService (non-persistent), Session ID: "alice_session"
2. **Agent Instantiation**: Agent can be instantiated without errors
3. **Agent Methods**: agent.run() method is available for processing messages
4. **Session Persistence**: Session state persists across agent restarts (SQLite database)
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd.md" title="Product Requirements Document" section="Agent Core & Identity (FR1-FR4)">
        <snippet>FR1: Agent maintains a persistent identity ("Companion") associated with a specific user. FR2: Agent stores and retrieves user context (name, preferences, schedule) from memory. FR3: Agent enforces a "Trusted Contact" list to control access to its MCP tools. FR4: Agent can initiate A2A communication with other known Companions.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Technology Stack Details - AI & Agent Framework">
        <snippet>Google ADK v1.19.0+ (Agent framework), Gemini 2.5 Pro (`gemini-2.5-pro`) - LLM, A2A Protocol (Native in ADK) - Agent-to-agent communication.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="ADR-001: Use Gemini 2.5 Pro instead of Gemini 3 Pro Preview">
        <snippet>Decision: Use Gemini 2.5 Pro (stable, released June 2025). Rationale: Demo reliability outweighs marginal capability gains. Judges care about working demo, not latest model.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="ADR-002: SQLite for Session Persistence">
        <snippet>Decision: Use DatabaseSessionService with SQLite. Consequences: Sessions persist across demo restarts, no server setup required, easy to inspect data during development.</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="ADR-004: In-Memory Long-Term Memory (Not Persistent)">
        <snippet>Decision: Use InMemoryMemoryService (non-persistent). Rationale: PRD doesn't require cross-session learning for MVP. Demo scenario is self-contained ("Plan dinner this weekend").</snippet>
      </doc>
      <doc path="docs/architecture.md" title="Architecture Document" section="Project Structure">
        <snippet>alice_companion/agent.py - ADK agent definition. Database file: companion_sessions.db in project root (shared with Bob's agent).</snippet>
      </doc>
      <doc path="docs/epics.md" title="Epic 2: Companion Agent Core" section="Story 2.2: Initialize Alice's Companion Agent with ADK">
        <snippet>Agent is configured with: Agent name: "Alice's Companion", Model: Gemini 2.5 Pro (`gemini-2.5-pro`), System instruction: "You are Alice's personal Companion agent. You coordinate plans on Alice's behalf...", SessionService: DatabaseSessionService with SQLite (`companion_sessions.db`), MemoryService: InMemoryMemoryService (non-persistent), Session ID: "alice_session". FR1 satisfied: persistent identity.</snippet>
      </doc>
      <doc path="docs/ux-design-specification.md" title="UX Design Specification" section="Core User Experience">
        <snippet>Core Experience: User says "Plan dinner with Bob", and the AIs negotiate availability and preferences in the background, presenting a final option for approval. Platform: Web-based Gradio Demo (Split-screen desktop view).</snippet>
      </doc>
    </docs>
    <code>
      <artifact path="shared/models.py" kind="data-model" symbol="UserContext, EventProposal, SharingRule" lines="1-62" reason="Data models from Story 2.1 that will be used by Alice's agent for storing user context. Agent will need to use UserContext dataclass in Story 2.4." />
      <artifact path="alice_companion/__init__.py" kind="package" symbol="alice_companion package" lines="1" reason="Package structure established in Story 1.2. Agent implementation will go in alice_companion/agent.py." />
      <artifact path="tests/verify_models.py" kind="test-pattern" symbol="verification script pattern" reason="Epic 1 verification pattern to follow for creating tests/verify_alice_agent.py. Team agreement: Always create and run verification scripts before marking tasks complete." />
      <artifact path="tests/test_models.py" kind="test-pattern" symbol="test file pattern" reason="Test patterns established in Story 2.1. Follow same pattern for tests/test_alice_agent.py." />
    </code>
    <dependencies>
      <ecosystem name="python">
        <package name="google-adk" version=">=1.19.0" />
        <package name="mcp" version=">=1.22.0" />
        <package name="gradio" />
        <package name="python-dotenv" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Agent Framework: Use Google ADK (Agent Development Kit) for agent initialization [Source: docs/architecture.md#L229]</constraint>
    <constraint>Model Selection: Use Gemini 2.5 Pro (`gemini-2.5-pro`) for stability, not Gemini 3 Pro preview (ADR-001) [Source: docs/architecture.md#L229]</constraint>
    <constraint>Session Service: Use DatabaseSessionService with SQLite for session persistence (ADR-002) [Source: docs/architecture.md#L232]</constraint>
    <constraint>Memory Service: Use InMemoryMemoryService for long-term memory (non-persistent, ADR-004) [Source: docs/architecture.md#L233]</constraint>
    <constraint>System Instruction: Should emphasize coordination, privacy, and natural conversation [Source: docs/epics.md#L382]</constraint>
    <constraint>Session ID: Use "alice_session" to prevent state collision with Bob's agent [Source: docs/epics.md#L370]</constraint>
    <constraint>Database File: SQLite file `companion_sessions.db` in project root [Source: docs/architecture.md#L247]</constraint>
    <constraint>File Location: `alice_companion/agent.py` (already exists from Story 1.2) [Source: docs/architecture.md#L248]</constraint>
    <constraint>Verification Script Pattern: Continue `tests/verify_*.py` pattern established in Epic 1 - apply to agent initialization verification [Source: docs/sprint-artifacts/epic-1-retro-2025-12-02.md#L39-43]</constraint>
    <constraint>Team Agreement - Verification First: Always create and run verification scripts before marking tasks complete [Source: docs/sprint-artifacts/epic-1-retro-2025-12-02.md#L224]</constraint>
    <constraint>Process Improvement: Verify installations/configurations with actual commands/tests, not just file existence [Source: docs/sprint-artifacts/epic-1-retro-2025-12-02.md#L176-180]</constraint>
    <constraint>Quality Standard: Maintain clean implementation standards established in Epic 1 (Story 1.2 was approved with zero issues) [Source: docs/sprint-artifacts/epic-1-retro-2025-12-02.md#L51-54]</constraint>
  </constraints>

  <interfaces>
    <interface name="Agent.run()" kind="method" signature="agent.run(message: str) -> str" path="alice_companion/agent.py" />
    <interface name="DatabaseSessionService" kind="class" signature="DatabaseSessionService(database_path: str)" path="google-adk" />
    <interface name="InMemoryMemoryService" kind="class" signature="InMemoryMemoryService()" path="google-adk" />
    <interface name="Agent" kind="class" signature="Agent(name: str, model: str, system_instruction: str, session_service: SessionService, memory_service: MemoryService, session_id: str)" path="google-adk" />
  </interfaces>

  <tests>
    <standards>Testing follows Epic 1 patterns: Create verification scripts (`tests/verify_*.py`) that programmatically validate all acceptance criteria. Test files (`tests/test_*.py`) use standard Python unittest or pytest patterns. Always run verification scripts before marking tasks complete. Test coverage: instantiation, agent.run() method, session persistence.</standards>
    <locations>tests/ directory (tests/verify_alice_agent.py, tests/test_alice_agent.py)</locations>
    <ideas>
      <test ac="1">Test agent instantiation with all required components (name, model, system_instruction, session_service, memory_service, session_id)</test>
      <test ac="2">Test agent can be instantiated without errors (no exceptions raised)</test>
      <test ac="3">Test agent.run() method exists and is callable</test>
      <test ac="3">Test agent.run() with simple message ("Hello") returns response</test>
      <test ac="4">Test session state is created in SQLite database after agent instantiation</test>
      <test ac="4">Test session state persists after agent restart (create agent, use it, destroy, recreate, verify state)</test>
      <test ac="4">Test session data is retrievable after restart (verify specific session data can be read)</test>
    </ideas>
  </tests>
</story-context>

